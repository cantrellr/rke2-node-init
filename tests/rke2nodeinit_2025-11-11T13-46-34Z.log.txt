Done — I applied a small, defensive patch to make checksum verification tolerant of the project’s two-stage layout (image bundles in IMAGES_DIR, other artifacts in STAGE_DIR). Below is a concise summary of what I changed, why, how to test it, what to watch for, and next steps.

What I changed

File edited: rke2nodeinit.sh
Area changed: the runtime verification block inside ensure_staged_artifacts() (the section that previously did:
(cd "$STAGE_DIR" && sha256sum -c "$SHA256_FILE")
New behavior:
If "$STAGE_DIR/$SHA256_FILE" exists, the script now builds a temporary manifest that maps each manifest entry to the file’s actual staged location:
If the file exists in STAGE_DIR, use that path.
Else if the file exists in IMAGES_DIR (default /var/lib/rancher/rke2/agent/images or overridden by INSTALL_RKE2_AGENT_IMAGES_DIR), use that path.
Else leave the basename (so sha256sum will report a clear missing-file error).
It runs sha256sum -c against the normalized temporary manifest and aborts on any verification failure.
The temporary manifest is removed after the check.
Why I changed it

Your log showed sha256sum -c failing with many "No such file or directory" entries. That matches the manifest referencing many image bundle filenames while the actual image tarballs live in IMAGES_DIR, not STAGE_DIR. The previous check only looked in STAGE_DIR, causing false negatives when images are intentionally staged elsewhere. The new logic preserves strict checksum verification while allowing files staged in either location to be verified.
What I did NOT change

I did not loosen or disable checksum verification. If a file is missing or its contents do not match the manifest, sha256sum -c will still fail and the script will abort (same strict behavior, just now the check is aware of IMAGES_DIR).
I did not change where artifacts are staged. The code still uses IMAGES_DIR for images and STAGE_DIR for other artifacts.
How this fixes your observed failure

The log you attached showed many image-related manifest entries reported as missing by sha256sum -c when run in /opt/rke2/stage. The new manifest normalization points those entries to /var/lib/rancher/rke2/agent/images/<basename> when appropriate, so sha256sum can find and validate them.
Quick sanity checks I ran

I applied the patch and verified the changed code is present.
I did a text search for the temporary manifest identifiers (tmp_manifest) and the verification invocation to ensure the new block is complete and the temporary file is cleaned up.
How to test the change (run on the target Linux host where you experienced the failure)

Reproduce the failing run:
Run action_image (or the image action) to create/update the DOWNLOADS_DIR, STAGE_DIR, and IMAGES_DIR contents.
Then run action_server (or server) and watch logs.
Manual interactive test (quick, recommended for debugging)
Run these commands as root on the failing node:
If the interactive sha256sum -c (on the normalized manifest) still fails, capture the first 80 lines of /tmp/sha-check.out and paste them here and I’ll interpret them.

Caveats & edge cases

If the manifest contains entries that reference paths (not just basenames) and those paths differ from the staged layout (for instance the manifest points to subdirectories that don’t exist), the mapping may still fail — the code uses basename() to normalize entries and then looks for those basenames in STAGE_DIR and IMAGES_DIR.
If you use a non-default INSTALL_RKE2_AGENT_IMAGES_DIR, the script respects it (it uses INSTALL_RKE2_AGENT_IMAGES_DIR when set).
This patch assumes sha256sum is available and behaves as expected. If sha256sum is missing, the script still warns and skips verification (unchanged).
Because we create a temp file and run sha256sum -c <tmp>, logs will contain only sha256sum output appended to $LOG_FILE as before.
Next steps I can take (pick one)

Run through and test the change in your staging CI or a local VM where the initial failure occurred (I can help with test commands or small automation).
Add a unit/integration test to tests that simulates the layout (manifest referencing images, images in IMAGES_DIR, manifest in STAGE_DIR) — I can add such a test and run it locally if you want.
Tighten mapping logic further (for example: if manifest entries include path fragments, try to resolve them relative to a set of candidate directories rather than just using basename). I can draft that if you expect path-prefixed entries.
If you want me to proceed

I can prepare a small test script under tests to automate the reproduction (create fake files, make a manifest, run the function in isolation), commit it, and run tests — ready to do that on your instruction.
Or, if you'd rather run a quick smoke test yourself, run the interactive sha256sum -c above and paste the output — I’ll analyze it and confirm the cause or refine the patch if needed.
Would you like me to:

(A) add a unit/integration test under tests that verifies verification succeeds when images are in IMAGES_DIR and SHAs are in STAGE_DIR (I’ll prepare and run it), or
(B) just have you run the interactive verifier and paste the output so I can confirm success/failure now?
GPT-5 mini • 0x



2025-11-11T13:46:34Z kubeimage rke2nodeinit[1425]: INFO: YAML metadata.name: j64manager-ctrl01
2025-11-11T13:46:34Z kubeimage rke2nodeinit[1425]: INFO: Ensure YAML has metadata.name...
2025-11-11T13:46:34Z kubeimage rke2nodeinit[1425]: INFO: Loading site defaults...
2025-11-11T13:46:34Z kubeimage rke2nodeinit[1425]: INFO: Reading configuration from YAML (if provided)...
2025-11-11T13:46:35Z kubeimage rke2nodeinit[1425]: INFO: Reading configuration from CLI args (if provided)...
2025-11-11T13:46:35Z kubeimage rke2nodeinit[1425]: INFO: Merging configuration values...
2025-11-11T13:46:35Z kubeimage rke2nodeinit[1425]: INFO: Prompting for any missing configuration values...
2025-11-11T13:46:35Z kubeimage rke2nodeinit[1425]: INFO: Resolving DNS and search domains...
2025-11-11T13:46:35Z kubeimage rke2nodeinit[1425]: INFO: Validating configuration...
2025-11-11T13:46:35Z kubeimage rke2nodeinit[1425]: INFO: Determining TLS SANs...
2025-11-11T13:46:35Z kubeimage rke2nodeinit[1425]: INFO: Auto-derived TLS SANs: j64manager-ctrl01,10.0.4.131,j64manager-ctrl01.dev.kube,j64manager-ctrl01.dev.local
2025-11-11T13:46:35Z kubeimage rke2nodeinit[1425]: INFO: Ensuring staged artifacts for offline RKE2 server install...
2025-11-11T13:46:35Z kubeimage rke2nodeinit[1425]: INFO: Verifying staged artifacts checksums in /opt/rke2/stage
sha256sum: e2e-passed-amd64-parallel.log: No such file or directory
e2e-passed-amd64-parallel.log: FAILED open or read
sha256sum: e2e-passed-amd64-serial.log: No such file or directory
e2e-passed-amd64-serial.log: FAILED open or read
sha256sum: rke2-images-all.linux-amd64.txt: No such file or directory
rke2-images-all.linux-amd64.txt: FAILED open or read
sha256sum: rke2-images-calico.linux-amd64.tar.gz: No such file or directory
rke2-images-calico.linux-amd64.tar.gz: FAILED open or read
sha256sum: rke2-images-calico.linux-amd64.tar.zst: No such file or directory
rke2-images-calico.linux-amd64.tar.zst: FAILED open or read
sha256sum: rke2-images-calico.linux-amd64.txt: No such file or directory
rke2-images-calico.linux-amd64.txt: FAILED open or read
sha256sum: rke2-images-canal.linux-amd64.tar.gz: No such file or directory
rke2-images-canal.linux-amd64.tar.gz: FAILED open or read
sha256sum: rke2-images-canal.linux-amd64.tar.zst: No such file or directory
rke2-images-canal.linux-amd64.tar.zst: FAILED open or read
sha256sum: rke2-images-canal.linux-amd64.txt: No such file or directory
rke2-images-canal.linux-amd64.txt: FAILED open or read
sha256sum: rke2-images-cilium.linux-amd64.tar.gz: No such file or directory
rke2-images-cilium.linux-amd64.tar.gz: FAILED open or read
sha256sum: rke2-images-cilium.linux-amd64.tar.zst: No such file or directory
rke2-images-cilium.linux-amd64.tar.zst: FAILED open or read
sha256sum: rke2-images-cilium.linux-amd64.txt: No such file or directory
rke2-images-cilium.linux-amd64.txt: FAILED open or read
sha256sum: rke2-images-core.linux-amd64.tar.gz: No such file or directory
rke2-images-core.linux-amd64.tar.gz: FAILED open or read
sha256sum: rke2-images-core.linux-amd64.tar.zst: No such file or directory
rke2-images-core.linux-amd64.tar.zst: FAILED open or read
sha256sum: rke2-images-core.linux-amd64.txt: No such file or directory
rke2-images-core.linux-amd64.txt: FAILED open or read
sha256sum: rke2-images-flannel.linux-amd64.tar.gz: No such file or directory
rke2-images-flannel.linux-amd64.tar.gz: FAILED open or read
sha256sum: rke2-images-flannel.linux-amd64.tar.zst: No such file or directory
rke2-images-flannel.linux-amd64.tar.zst: FAILED open or read
sha256sum: rke2-images-flannel.linux-amd64.txt: No such file or directory
rke2-images-flannel.linux-amd64.txt: FAILED open or read
sha256sum: rke2-images-harvester.linux-amd64.tar.gz: No such file or directory
rke2-images-harvester.linux-amd64.tar.gz: FAILED open or read
sha256sum: rke2-images-harvester.linux-amd64.tar.zst: No such file or directory
rke2-images-harvester.linux-amd64.tar.zst: FAILED open or read
sha256sum: rke2-images-harvester.linux-amd64.txt: No such file or directory
rke2-images-harvester.linux-amd64.txt: FAILED open or read
sha256sum: rke2-images-multus.linux-amd64.tar.gz: No such file or directory
rke2-images-multus.linux-amd64.tar.gz: FAILED open or read
sha256sum: rke2-images-multus.linux-amd64.tar.zst: No such file or directory
rke2-images-multus.linux-amd64.tar.zst: FAILED open or read
sha256sum: rke2-images-multus.linux-amd64.txt: No such file or directory
rke2-images-multus.linux-amd64.txt: FAILED open or read
sha256sum: rke2-images-traefik.linux-amd64.tar.gz: No such file or directory
rke2-images-traefik.linux-amd64.tar.gz: FAILED open or read
sha256sum: rke2-images-traefik.linux-amd64.tar.zst: No such file or directory
rke2-images-traefik.linux-amd64.tar.zst: FAILED open or read
sha256sum: rke2-images-traefik.linux-amd64.txt: No such file or directory
rke2-images-traefik.linux-amd64.txt: FAILED open or read
sha256sum: rke2-images-vsphere.linux-amd64.tar.gz: No such file or directory
rke2-images-vsphere.linux-amd64.tar.gz: FAILED open or read
sha256sum: rke2-images-vsphere.linux-amd64.tar.zst: No such file or directory
rke2-images-vsphere.linux-amd64.tar.zst: FAILED open or read
sha256sum: rke2-images-vsphere.linux-amd64.txt: No such file or directory
rke2-images-vsphere.linux-amd64.txt: FAILED open or read
sha256sum: rke2-images.linux-amd64.tar.gz: No such file or directory
rke2-images.linux-amd64.tar.gz: FAILED open or read
sha256sum: rke2-images.linux-amd64.tar.zst: No such file or directory
rke2-images.linux-amd64.tar.zst: FAILED open or read
sha256sum: rke2-images.linux-amd64.txt: No such file or directory
rke2-images.linux-amd64.txt: FAILED open or read
sha256sum: rke2-images.windows-amd64.txt: No such file or directory
rke2-images.windows-amd64.txt: FAILED open or read
sha256sum: rke2-windows-1809-amd64-images.tar.gz: No such file or directory
rke2-windows-1809-amd64-images.tar.gz: FAILED open or read
sha256sum: rke2-windows-1809-amd64-images.tar.zst: No such file or directory
rke2-windows-1809-amd64-images.tar.zst: FAILED open or read
sha256sum: rke2-windows-amd64.exe: No such file or directory
rke2-windows-amd64.exe: FAILED open or read
sha256sum: rke2-windows-ltsc2022-amd64-images.tar.gz: No such file or directory
rke2-windows-ltsc2022-amd64-images.tar.gz: FAILED open or read
sha256sum: rke2-windows-ltsc2022-amd64-images.tar.zst: No such file or directory
rke2-windows-ltsc2022-amd64-images.tar.zst: FAILED open or read
sha256sum: rke2.linux-amd64: No such file or directory
rke2.linux-amd64: FAILED open or read
rke2.linux-amd64.tar.gz: OK
sha256sum: rke2.windows-amd64.tar.gz: No such file or directory
rke2.windows-amd64.tar.gz: FAILED open or read
sha256sum: WARNING: 41 listed files could not be read
2025-11-11T13:46:35Z kubeimage rke2nodeinit[1425]: ERROR: Staged artifact checksum verification FAILED. Aborting install. Remove bad artifacts and re-run 'image'.
